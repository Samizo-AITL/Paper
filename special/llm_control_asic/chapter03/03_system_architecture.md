# 第3章 システムアーキテクチャ設計（詳解）

## 3.1 ハイブリッド設計の基本コンセプト

### 3.1.1 なぜハイブリッド設計が必要か？

LLMは、自然言語処理や推論などの「高次知能タスク」に強く、  
制御理論は、時間応答や外乱抑制などの「リアルタイム安定制御」に優れています。  
これらを統合することで、「状況理解・意思決定」から「物理的な実行」まで一貫した知能システムが実現可能になります。

### 3.1.2 アーキテクチャ全体像（概念図）

```
[センサ] → [信号前処理] → [制御ブロック] → [アクチュエータ]
                         ↘︎
                        [LLMブロック（推論・最適化・判断）]
```

- 制御ブロックは、リアルタイム動作と安定性確保を担う  
- LLMブロックは、行動計画や異常検知、チューニング補助などを担う  
- 両者のやり取りは「非同期通信」または「イベント駆動型連携」で行う

---

## 3.2 LLMと制御モジュールの役割分担と連携

### 3.2.1 機能分離の原則

| 項目           | LLMブロック                          | 制御ブロック                        |
|----------------|--------------------------------------|--------------------------------------|
| 主な機能       | 状況理解、判断、最適化支援           | 安定制御、応答性、ロバスト性         |
| 時間特性       | 準リアルタイム／非同期                | リアルタイム（ms〜μsオーダ）         |
| 実装形式       | ソフトウェア or 専用アクセラレータ     | デジタル制御回路（FPGA/ASIC）        |

### 3.2.2 連携の方法

- **ポーリング式**（周期的に制御からLLMに問い合わせ）  
- **イベント駆動式**（異常や外乱に応じてLLMに割り込み送信）  
- **コマンドキュー式**（LLMが指令列を生成し制御に送る）

### 3.2.3 データの流れ例

- センサ→DSP→制御ブロック  
- 制御ブロック→状態ログ→LLM  
- LLM→最適パラメータ提案→制御ブロックに反映

---

## 3.3 センサ信号処理とインターフェース設計

### 3.3.1 センサ信号処理のステップ

1. **ADC変換**：アナログセンサ信号をデジタル値へ変換  
2. **フィルタ処理**：ノイズを除去（ローパス／カルマン／FIR等）  
3. **特徴抽出**：エッジ、傾き、変化率などを計算

### 3.3.2 処理ブロックの分担

| 機能                 | 担当                           |
|----------------------|--------------------------------|
| ADC、簡易フィルタ     | ハードウェア（回路 or FPGA）     |
| 高度処理、学習適用   | ソフトウェア／LLM                |

### 3.3.3 インターフェース仕様

- **SPI/I2C**：センサとの低速通信  
- **AXI4-stream**：FPGA内部の高速信号バス  
- **UART/CAN**：LLM⇄制御のシンプル通信

---

## 3.4 ソフトウェアとハードウェアの統合戦略

### 3.4.1 分担設計の原則

- 時間制約が厳しい部分はハードウェア（例：制御ループ）  
- 柔軟性が求められる部分はソフトウェア（例：LLM）  
- 境界は明確にし、**通信プロトコル・フォーマットを定義**しておくことが重要

### 3.4.2 デバッグ戦略

- ハードウェア（FPGA）内の信号は **ロジックアナライザ** で観測  
- ソフトウェアログと時刻同期させて事象を追跡  
- システム全体で **トレースバッファ** を設け、異常時の状態を取得

### 3.4.3 開発ツール例

- HDL設計：Vivado, Quartus  
- HLS：Vitis HLS, Intel HLS Compiler  
- デバッグ：Xilinx ILA, Verilator, GDB  
- 制御シミュレーション：Simulink + HDL Coder

---

## まとめ

この章では、LLMと制御モジュールをどう分担し、どう統合するかを設計視点で整理しました。  
アーキテクチャの段階で通信方法・機能責任・処理境界を明確にしておくことで、後工程の実装やテストが効率的になります。  

次章では、実際の **制御設計** と **LLM連携設計** を詳細に扱います。

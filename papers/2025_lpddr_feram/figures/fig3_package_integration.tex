% ==== Fig. 3: Package cross-section (LPDDR+FeRAM Chiplet Integration) ====
\begin{figure}[t]
  \centering
  % 2段組の列幅に必ず収める（文字サイズも含めて一括スケール）
  \resizebox{\columnwidth}{!}{%
  \begin{tikzpicture}[node distance=8mm, font=\scriptsize, >=latex]

    % ---- 上段：CPU/Controller ----
    \node[draw, thick, fill=gray!15,
          minimum width=0.38\columnwidth, minimum height=9mm] (cpu) {CPU / Controller};

    % ---- 下段：LPDDR ----
    \node[draw, thick, fill=gray!15,
          minimum width=0.38\columnwidth, minimum height=9mm,
          below=of cpu] (lpddr) {LPDDR DRAM Chip};

    % ---- 右：FeRAM chiplet ----
    \node[draw, thick, fill=gray!15,
          minimum width=0.32\columnwidth, minimum height=9mm,
          right=13mm of lpddr] (feram) {FeRAM Chiplet};

    % ---- SystemDK supervision（3ブロックを囲う）----
    \node[draw, thick, dashed, rounded corners,
          inner sep=5mm, fit=(cpu) (lpddr) (feram), name=systemdk] {};

    % ラベルは枠から少し内側に
    \node[font=\scriptsize\itshape, anchor=north west]
      at ($(systemdk.north west)+(1mm,-1mm)$) {SystemDK Co-Design Supervision};

    % ---- 相互接続矢印 ----
    \draw[->, thick] (cpu.south) -- (lpddr.north) node[midway, left] {high bandwidth};
    \draw[->, thick] (cpu.east) -- (feram.west) node[midway, above] {checkpoint / state};
    \draw[<->, thick, dashed] (lpddr.east) -- ([yshift=-1mm]feram.south west)
      node[midway, below] {refresh offloading};

    % ---- Substrate / Interposer ----
    % systemdk.south は座標なので一度拾ってから below= で配置
    \path (systemdk.south) coordinate (baseS);
    \node[draw, thick, fill=gray!10,
          minimum width=0.95\columnwidth, minimum height=4mm,
          below=10mm of baseS] (substrate) {};
    \node[align=center] at (substrate)
      {Package Substrate / Interposer (SiP/PoP)};

  \end{tikzpicture}%
  }
  \vspace{-0.6ex}
  \caption{Package-level integration of LPDDR and FeRAM chiplet under SystemDK supervision.
  LPDDR serves as main working memory, while FeRAM provides checkpointing and refresh suppression via a common substrate (SiP/PoP).}
  \label{fig:package_lpddr_feram}
\end{figure}

name: Build LaTeX PDF (FeFET CMOS018 Reliability)

on:
  push:
    branches: [ main ]          # まずは確実に発火させる
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1) main.tex を自動発見（papers 以下の “*fefet*cmos018*reliability*/main.tex” を最優先）
      - name: Locate main.tex
        id: loc
        shell: bash
        run: |
          set -euo pipefail
          echo "== search candidates =="
          # 優先パターン
          CAND=$(find papers -type f -iname "main.tex" \
                 | grep -i "fefet" | grep -i "cmos018" | grep -i "reliability" | head -n 1 || true)
          # 見つからなければ汎用
          if [[ -z "${CAND}" ]]; then
            CAND=$(find papers -type f -iname "main.tex" | head -n 1 || true)
          fi
          if [[ -z "${CAND}" ]]; then
            echo "main.tex not found under papers/ . repo tree follows:" >&2
            ls -R | sed -n '1,200p' >&2
            exit 1
          fi
          echo "FOUND=${CAND}"
          WORKDIR=$(dirname "${CAND}")
          BASENAME=$(basename "${CAND}")
          echo "workdir=${WORKDIR}" >> $GITHUB_OUTPUT
          echo "root=${BASENAME}"    >> $GITHUB_OUTPUT
          # デバッグ表示
          echo "::notice title=Found::${WORKDIR}/${BASENAME}"

      # 2) ビルド
      - name: Build LaTeX (lualatex)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: ${{ steps.loc.outputs.root }}
          working_directory: ${{ steps.loc.outputs.workdir }}
          work_in_root_file_dir: true
          latexmk_use_lualatex: true
          args: -file-line-error -interaction=nonstopmode

      # 3) 生成物アップロード（PDF/LOG）
      - name: Upload PDF and log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fefet_cmos018_reliability_artifacts
          path: |
            ${{ steps.loc.outputs.workdir }}/*.pdf
            ${{ steps.loc.outputs.workdir }}/*.log
          if-no-files-found: warn
